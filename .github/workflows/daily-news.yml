# å…¨çƒç§‘æŠ€æ–°é—»è‡ªåŠ¨åŒ–ç³»ç»Ÿ - GitHub Actionså·¥ä½œæµ
# æ¯å¤©æ—©ä¸Š8:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è‡ªåŠ¨ç”Ÿæˆç§‘æŠ€æ–°é—»

name: Daily Tech News

on:
  # å®šæ—¶è§¦å‘ï¼ˆUTC 00:30 = åŒ—äº¬æ—¶é—´ 8:30ï¼‰
  schedule:
    - cron: '30 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      send_to_getnote:
        description: 'å‘é€åˆ°Getç¬”è®°'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# æƒé™è®¾ç½®
permissions:
  contents: write
  actions: read

jobs:
  generate-news:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # æ­¥éª¤3: å®‰è£…ç³»ç»Ÿä¾èµ–
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk
          fc-cache -fv
      
      # æ­¥éª¤4: å®‰è£…Pythonä¾èµ–
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      # æ­¥éª¤5: ç”Ÿæˆæ–°é—»å’Œå›¾ç‰‡
      - name: Generate tech news
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          GNEWS_KEY: ${{ secrets.GNEWS_KEY }}
          TIANXING_KEY: ${{ secrets.TIANXING_KEY }}
          GETNOTE_API_KEY: ${{ secrets.GETNOTE_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.send_to_getnote }}" = "true" ]; then
            python3 main.py --send
          else
            python3 main.py --test
          fi
      
      # æ­¥éª¤6: ä¸Šä¼ ç”Ÿæˆçš„å›¾ç‰‡
      - name: Upload images
        uses: actions/upload-artifact@v4
        with:
          name: tech-news-images-${{ github.run_id }}
          path: |
            output/*.jpg
            output/*.png
          retention-days: 30
      
      # æ­¥éª¤7: æäº¤ç”Ÿæˆçš„æ–‡ä»¶åˆ°ä»“åº“
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
          git add output/
          git add logs/ 2>/dev/null || true
          
          # æäº¤ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
          git commit -m "ğŸ“° Update daily tech news - $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          
          # æ¨é€
          git push || echo "Nothing to push"
      
      # æ­¥éª¤8: åˆ›å»ºReleaseï¼ˆå¯é€‰ï¼‰
      - name: Create Release
        if: github.event_name == 'schedule'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: daily-${{ github.run_id }}
          name: Tech News ${{ github.run_date }}
          body: |
            è‡ªåŠ¨ç”Ÿæˆç§‘æŠ€æ–°é—»æ—¥æŠ¥
            ç”Ÿæˆæ—¶é—´: ${{ github.run_date }}
          files: |
            output/*.jpg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # å¯é€‰ï¼šå‘é€é€šçŸ¥
  notify:
    needs: generate-news
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Send notification
        run: |
          echo "æ–°é—»ç”Ÿæˆå®Œæˆï¼"
          echo "çŠ¶æ€: ${{ needs.generate-news.result }}"
