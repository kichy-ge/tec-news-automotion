# 🚀 全球科技新闻自动化系统 - 部署指南

## 📋 部署方式选择

| 方式 | 适用场景 | 难度 | 推荐度 |
|------|---------|------|--------|
| **本地服务器/VPS** | 有Linux服务器 | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **Docker部署** | 熟悉容器化 | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **云函数/Serverless** | 无服务器经验 | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| **GitHub Actions** | 免费定时任务 | ⭐ | ⭐⭐⭐⭐ |

---

## 方式一：本地服务器/VPS部署（推荐）

### 1. 环境要求

- **操作系统**: Linux (Ubuntu 20.04+/CentOS 7+)
- **Python**: 3.8+
- **内存**: 至少 512MB
- **磁盘**: 至少 1GB 可用空间

### 2. 部署步骤

#### 步骤1：下载代码

```bash
# 创建项目目录
mkdir -p /opt/tech-news
cd /opt/tech-news

# 下载代码（假设代码在GitHub上）
git clone https://github.com/yourusername/tech-news-automation.git .
# 或者手动上传代码到该目录
```

#### 步骤2：安装依赖

```bash
# 安装Python依赖
pip3 install Pillow requests

# 安装中文字体
sudo apt-get update
sudo apt-get install -y fonts-noto-cjk

# 验证字体安装
fc-list :lang=zh | grep Noto
```

#### 步骤3：配置API密钥

```bash
# 编辑运行脚本
nano run.sh

# 修改以下行，填入你的API密钥
export NEWSAPI_KEY="b1b5dc1e64064cddb26ab4d984642ba3"
export GNEWS_KEY="626d1ce5f0c532755f3952c362034952"
```

#### 步骤4：测试运行

```bash
# 测试模式（不发送）
python3 main.py --test

# 检查输出
ls -la output/
```

#### 步骤5：设置定时任务

```bash
# 编辑crontab
crontab -e

# 添加以下行（每天早上8:30运行）
30 8 * * * cd /opt/tech-news && ./run.sh

# 保存并退出
```

#### 步骤6：验证定时任务

```bash
# 查看crontab列表
crontab -l

# 查看cron日志
tail -f /var/log/syslog | grep CRON
```

---

## 方式二：Docker部署

### 1. 创建Dockerfile

```dockerfile
FROM python:3.11-slim

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    fonts-noto-cjk \
    cron \
    && rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /app

# 复制项目文件
COPY . .

# 安装Python依赖
RUN pip install --no-cache-dir Pillow requests

# 设置环境变量
ENV NEWSAPI_KEY="your_newsapi_key"
ENV GNEWS_KEY="your_gnews_key"
ENV PYTHONUNBUFFERED=1

# 添加定时任务
RUN echo "30 8 * * * cd /app && python3 main.py --send >> /var/log/cron.log 2>&1" | crontab -

# 启动cron
CMD ["cron", "-f"]
```

### 2. 构建并运行

```bash
# 构建镜像
docker build -t tech-news-automation .

# 运行容器
docker run -d \
  --name tech-news \
  -e NEWSAPI_KEY="b1b5dc1e64064cddb26ab4d984642ba3" \
  -e GNEWS_KEY="626d1ce5f0c532755f3952c362034952" \
  -v $(pwd)/output:/app/output \
  -v $(pwd)/logs:/app/logs \
  tech-news-automation

# 查看日志
docker logs -f tech-news
```

### 3. 使用Docker Compose

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  tech-news:
    build: .
    container_name: tech-news-automation
    environment:
      - NEWSAPI_KEY=b1b5dc1e64064cddb26ab4d984642ba3
      - GNEWS_KEY=626d1ce5f0c532755f3952c362034952
    volumes:
      - ./output:/app/output
      - ./logs:/app/logs
    restart: unless-stopped
```

运行：

```bash
docker-compose up -d
```

---

## 方式三：GitHub Actions部署（免费）

### 1. 创建GitHub仓库

将代码推送到GitHub仓库

### 2. 创建Workflow文件

创建 `.github/workflows/daily-news.yml`:

```yaml
name: Daily Tech News

on:
  schedule:
    # 每天 UTC 00:30 (北京时间 8:30)
    - cron: '30 0 * * *'
  workflow_dispatch:  # 支持手动触发

jobs:
  generate-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install Pillow requests
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk
    
    - name: Generate news
      env:
        NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        GNEWS_KEY: ${{ secrets.GNEWS_KEY }}
      run: |
        python3 main.py --test
    
    - name: Upload images
      uses: actions/upload-artifact@v3
      with:
        name: tech-news-images
        path: output/*.jpg
    
    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add output/
        git commit -m "Update daily tech news - $(date +%Y-%m-%d)" || exit 0
        git push
```

### 3. 配置Secrets

在GitHub仓库设置中添加：
- `NEWSAPI_KEY`: 你的NewsAPI密钥
- `GNEWS_KEY`: 你的GNews密钥

### 4. 手动触发测试

进入Actions页面，点击"Run workflow"

---

## 方式四：云服务器部署（阿里云/腾讯云/AWS）

### 阿里云ECS部署示例

```bash
# 1. 购买ECS实例（推荐1核2GB，Ubuntu 22.04）
# 2. 连接服务器
ssh root@your-server-ip

# 3. 安装依赖
apt-get update
apt-get install -y python3 python3-pip fonts-noto-cjk git

# 4. 下载代码
cd /opt
git clone https://github.com/yourusername/tech-news-automation.git
cd tech-news-automation

# 5. 安装Python依赖
pip3 install -r requirements.txt

# 6. 配置API密钥
nano run.sh
# 修改 NEWSAPI_KEY 和 GNEWS_KEY

# 7. 设置定时任务
crontab -e
# 添加: 30 8 * * * cd /opt/tech-news-automation && ./run.sh

# 8. 测试
python3 main.py --test
```

---

## 方式五：NAS/树莓派部署

适合家庭用户，低功耗运行

```bash
# 树莓派/Raspberry Pi
sudo apt-get update
sudo apt-get install -y python3-pip fonts-noto-cjk

# 安装依赖
pip3 install Pillow requests --user

# 下载代码
cd ~
git clone https://github.com/yourusername/tech-news-automation.git
cd tech-news-automation

# 配置和运行
nano run.sh  # 配置API密钥
python3 main.py --test

# 设置定时任务
crontab -e
# 添加: 30 8 * * * cd /home/pi/tech-news-automation && ./run.sh
```

---

## 🔧 部署后配置

### 1. 配置Get笔记自动发送（可选）

编辑 `run.sh`:

```bash
# 配置Get笔记（如果需要自动发送）
export GETNOTE_API_KEY="your_getnote_api_key"
export GETNOTE_WEBHOOK_URL="your_webhook_url"
```

### 2. 配置邮件通知（可选）

```bash
# 安装邮件工具
sudo apt-get install -y mailutils

# 配置邮件发送（在run.sh中添加）
echo "科技早报已生成" | mail -s "Tech News $(date +%Y-%m-%d)" your-email@example.com
```

### 3. 配置推送通知（可选）

支持Pushover、Server酱、Bark等

---

## 📊 监控和维护

### 查看运行日志

```bash
# 查看最新日志
tail -f logs/tech-news-$(date +%Y%m%d).log

# 查看所有日志
ls -la logs/
```

### 检查定时任务

```bash
# 查看crontab
crontab -l

# 查看cron服务状态
sudo service cron status
```

### 磁盘空间监控

```bash
# 添加磁盘检查到crontab
0 8 * * * df -h /opt/tech-news | tail -1 | awk '{if($5>80) print "磁盘空间不足: "$5}' | mail -s "磁盘警告" admin@example.com
```

---

## 🐛 常见问题

### 问题1：定时任务不执行

```bash
# 检查cron服务
sudo service cron status
sudo service cron start

# 检查日志
grep CRON /var/log/syslog

# 手动测试
cd /opt/tech-news-automation && ./run.sh
```

### 问题2：中文显示乱码

```bash
# 安装中文字体
sudo apt-get install -y fonts-noto-cjk fonts-wqy-zenhei
fc-cache -fv

# 验证
fc-list :lang=zh
```

### 问题3：API请求失败

```bash
# 检查网络连接
ping newsapi.org

# 检查API密钥
curl "https://newsapi.org/v2/everything?q=test&apiKey=YOUR_KEY"

# 查看日志
cat logs/tech-news-*.log | grep -i error
```

### 问题4：图片生成失败

```bash
# 检查Pillow
python3 -c "from PIL import Image; print('Pillow OK')"

# 检查字体
python3 -c "from PIL import ImageFont; ImageFont.truetype('/usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc', 20); print('Font OK')"
```

---

## 🔒 安全建议

1. **保护API密钥**：不要将密钥提交到Git仓库
2. **使用环境变量**：将敏感信息放在环境变量中
3. **限制文件权限**：
   ```bash
   chmod 600 run.sh
   chmod 700 output/
   ```
4. **定期更新**：保持系统和依赖更新

---

## 📞 获取帮助

如有问题，请：
1. 查看日志文件 `logs/`
2. 检查配置文件
3. 参考 `README.md` 和 `使用指南.md`

---

## ✅ 部署检查清单

- [ ] 代码已上传到服务器
- [ ] Python依赖已安装
- [ ] 中文字体已安装
- [ ] API密钥已配置
- [ ] 测试运行成功
- [ ] 定时任务已设置
- [ ] 日志目录可写入
- [ ] 输出目录可写入
- [ ] （可选）Get笔记已配置
- [ ] （可选）邮件通知已配置

---

**部署完成后，明天早上8:30将自动生成第一份科技新闻早报！**
